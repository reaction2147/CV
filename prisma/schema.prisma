generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Tone {
  PROFESSIONAL
  WARM
  ENTHUSIASTIC
  FORMAL
}

enum LetterLength {
  SHORT
  STANDARD
  DETAILED
}

enum ApplicationStatus {
  DRAFT
  APPLIED
  INTERVIEW
  REJECTED
  OFFER
}

enum GeneratedDocumentType {
  CV
  COVER_LETTER
}

model UserSession {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  cvs       CV[]
  jobPostings JobPosting[]
  applications Application[]
  purchases OneTimePurchase[]
}

model CV {
  id             String       @id @default(cuid())
  session        UserSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId      String
  title          String       @default("Default CV")
  structuredData Json?
  rawText        String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  applications Application[]
}

model JobPosting {
  id                     String       @id @default(cuid())
  session                UserSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId              String
  title                  String
  company                String
  location               String?
  sourceUrl              String?
  rawDescription         String
  cleanedDescription     String?
  extractedRequirements  Json?
  extractedKeywords      Json?
  companyTone            String?
  roleSummary            String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  applications Application[]
}

model Application {
  id                String            @id @default(cuid())
  session           UserSession       @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId         String
  cv                CV                @relation(fields: [cvId], references: [id])
  cvId              String
  jobPosting        JobPosting        @relation(fields: [jobPostingId], references: [id])
  jobPostingId      String
  tone              Tone
  letterLength      LetterLength
  matchScore        Float?
  status            ApplicationStatus @default(DRAFT)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  generatedDocs     GeneratedDocument[]
  oneTimePurchases  OneTimePurchase[]
}

model GeneratedDocument {
  id                  String                 @id @default(cuid())
  application         Application            @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  applicationId       String
  type                GeneratedDocumentType
  htmlTemplate        String
  blurredPreviewHtml  String
  pdfUrl              String?
  atsScore            Int?
  atsFeedback         Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([applicationId, type])
  @@unique([applicationId, type])
}

model OneTimePurchase {
  id                    String          @id @default(cuid())
  session               UserSession     @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId             String
  application           Application     @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  applicationId         String
  type                  GeneratedDocumentType
  amount                Int
  stripePaymentIntentId String
  createdAt             DateTime @default(now())
}
